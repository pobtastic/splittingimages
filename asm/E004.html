<!DOCTYPE html>
<html>
<head>
<title>Splitting Images: Routine at E004</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="DFB2.html">DFB2</a>
</td>
<td class="up">Up: <a href="../maps/all.html#e004">Map</a></td>
<td class="next">
Next: <a href="E0E2.html">E0E2</a>
</td>
</tr>
</table>
<div class="description">E004: Generate Picture</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="D2A1.html">Game_Initialisation</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Pointer to level graphics data</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e004"></span>
<div class="comments">
<div class="paragraph">
<span class="register">IX</span> will point to one of: <table class="default">
<tr>
<th colspan="1" rowspan="1">Address</th>
<th colspan="1" rowspan="1">Level</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="5B00.html">GraphicsData_Level_01</a></td>
<td class="centre" colspan="1" rowspan="1">Level 01</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="6182.html">GraphicsData_Level_02</a></td>
<td class="centre" colspan="1" rowspan="1">Level 02</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="6AFF.html">GraphicsData_Level_03</a></td>
<td class="centre" colspan="1" rowspan="1">Level 03</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="730A.html">GraphicsData_Level_04</a></td>
<td class="centre" colspan="1" rowspan="1">Level 04</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="783C.html">GraphicsData_Level_05</a></td>
<td class="centre" colspan="1" rowspan="1">Level 05</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="7CFD.html">GraphicsData_Level_06</a></td>
<td class="centre" colspan="1" rowspan="1">Level 06</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="8106.html">GraphicsData_Level_07</a></td>
<td class="centre" colspan="1" rowspan="1">Level 07</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="89D2.html">GraphicsData_Level_08</a></td>
<td class="centre" colspan="1" rowspan="1">Level 08</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="9110.html">GraphicsData_Level_09</a></td>
<td class="centre" colspan="1" rowspan="1">Level 09</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="9772.html">GraphicsData_Level_10</a></td>
<td class="centre" colspan="1" rowspan="1">Level 10</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture</td>
<td class="address-2"><span id="e004"></span>E004</td>
<td class="instruction">LD HL,$A0E3</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="A0E3.html">Buffer_Image</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e007"></span>
<div class="comments">
<div class="paragraph">
Clear down the buffer ready for the new image to be generated.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e007"></span>E007</td>
<td class="instruction">LD BC,$0B40</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=0B40.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e00a"></span>E00A</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="1">Write 00 to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e00c"></span>E00C</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="3"><span class="register">DE</span>=<a href="A0E3.html">Buffer_Image</a>+01 (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e00d"></span>E00D</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e00e"></span>E00E</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e00f"></span>E00F</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">Clear 0B40 bytes of data in <a href="A0E3.html">Buffer_Image</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e011"></span>E011</td>
<td class="instruction">LD A,$80</td>
<td class="comment-1" rowspan="2">Write 80 to *<a href="E004.html#e0de">Line_Counter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e013"></span>E013</td>
<td class="instruction">LD ($E0DE),A</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Loop</td>
<td class="address-2"><span id="e016"></span>E016</td>
<td class="instruction">LD A,$80</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=80-*<a href="E004.html#e0de">Line_Counter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e018"></span>E018</td>
<td class="instruction">LD HL,$E0DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e01b"></span>E01B</td>
<td class="instruction">SUB (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e01c"></span>E01C</td>
<td class="instruction">LD B,$14</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=14.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e01e"></span>E01E</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="2">Load <span class="register">A</span> into <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e020"></span>E020</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e021"></span>E021</td>
<td class="instruction">LD HL,$A0E3</td>
<td class="comment-1" rowspan="1">Starting from the first address at <a href="A0E3.html">Buffer_Image</a>, stored in <span class="register">HL</span>...</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_CurrentLine_Loop</td>
<td class="address-2"><span id="e024"></span>E024</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">Keep adding <span class="register">DE</span> to <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e025"></span>E025</td>
<td class="instruction">DJNZ <a href="E004.html#e024">GeneratePicture_CurrentLine_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease counter by one and loop back to <a href="E004.html#e024">GeneratePicture_CurrentLine_Loop</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e027"></span>E027</td>
<td class="instruction">LD ($E0E0),HL</td>
<td class="comment-1" rowspan="1">Write <span class="register">HL</span> to *<a href="E004.html#e0e0">Buffer_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e02a"></span>E02A</td>
<td class="instruction">LD A,(IX+$00)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the level graphics data pointer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e02d"></span>E02D</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e02f"></span>E02F</td>
<td class="instruction">CP $C9</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e067">ProcessCompressedImageData</a> if <span class="register">A</span> is equal to C9.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e031"></span>E031</td>
<td class="instruction">JR Z,<a href="E004.html#e067">ProcessCompressedImageData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e033"></span>E033</td>
<td class="instruction">CP $CA</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e045">GeneratePicture_RLE_Decoding</a> if <span class="register">A</span> is equal to CA.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e035"></span>E035</td>
<td class="instruction">JR Z,<a href="E004.html#e045">GeneratePicture_RLE_Decoding</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e037"></span>E037</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Copy the level graphics data pointer into <span class="register">DE</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e039"></span>E039</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e03a"></span>E03A</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Exchange the <span class="register">DE</span> and <span class="register">HL</span> registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e03b"></span>E03B</td>
<td class="instruction">LD BC,$0014</td>
<td class="comment-1" rowspan="2">Copy 0014 bytes of data from <span class="register">HL</span> to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e03e"></span>E03E</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e040"></span>E040</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Update the level graphics data pointer in <span class="register">IX</span> with the progress made from <span class="register">HL</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e041"></span>E041</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e043"></span>E043</td>
<td class="instruction">JR <a href="E004.html#e0b0">GeneratePicture_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e0b0">GeneratePicture_Next</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e045"></span>
<div class="comments">
<div class="paragraph">
Run-length decoding.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_Decoding</td>
<td class="address-2"><span id="e045"></span>E045</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Copy the level graphics data pointer into <span class="register">DE</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e047"></span>E047</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_NormalData</td>
<td class="address-2"><span id="e048"></span>E048</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the level graphics data pointer in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e049"></span>E049</td>
<td class="instruction">CP $00</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e052">GeneratePicture_RLE_RepeatZero</a> if the byte is 00.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e04b"></span>E04B</td>
<td class="instruction">JR Z,<a href="E004.html#e052">GeneratePicture_RLE_RepeatZero</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e04d"></span>E04D</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Else, write the byte to the image buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e04e"></span>E04E</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the image buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e04f"></span>E04F</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e050"></span>E050</td>
<td class="instruction">JR <a href="E004.html#e048">GeneratePicture_RLE_NormalData</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e048">GeneratePicture_RLE_NormalData</a>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_RepeatZero</td>
<td class="address-2"><span id="e052"></span>E052</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e053"></span>E053</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the level graphics data pointer in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e054"></span>E054</td>
<td class="instruction">CP $00</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e061">GeneratePicture_RLE_Next</a> if the byte is 00.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e056"></span>E056</td>
<td class="instruction">JR Z,<a href="E004.html#e061">GeneratePicture_RLE_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e058"></span>E058</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy the fetched byte into <span class="register">B</span> as a repeat counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e059"></span>E059</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Write 00 to the image buffer.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_RepeatZero_Loop</td>
<td class="address-2"><span id="e05a"></span>E05A</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e05b"></span>E05B</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the image buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e05c"></span>E05C</td>
<td class="instruction">DJNZ <a href="E004.html#e05a">GeneratePicture_RLE_RepeatZero_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the byte repeat counter by one and loop back to <a href="E004.html#e05a">GeneratePicture_RLE_RepeatZero_Loop</a> until the counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e05e"></span>E05E</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e05f"></span>E05F</td>
<td class="instruction">JR <a href="E004.html#e048">GeneratePicture_RLE_NormalData</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e048">GeneratePicture_RLE_NormalData</a>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_Next</td>
<td class="address-2"><span id="e061"></span>E061</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e062"></span>E062</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="2">Update the level graphics data pointer in <span class="register">IX</span> with the progress made from <span class="register">DE</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e063"></span>E063</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e065"></span>E065</td>
<td class="instruction">JR <a href="E004.html#e0b0">GeneratePicture_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e0b0">GeneratePicture_Next</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e067"></span>
<div class="comments">
<div class="paragraph">
Second
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ProcessCompressedImageData</td>
<td class="address-2"><span id="e067"></span>E067</td>
<td class="instruction">LD B,(IX+$01)</td>
<td class="comment-1" rowspan="1">Load the repeat count into <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e06a"></span>E06A</td>
<td class="instruction">LD A,(IX+$00)</td>
<td class="comment-1" rowspan="2">Write the operation code to *<a href="E004.html#e0df">Operation_Code</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e06d"></span>E06D</td>
<td class="instruction">LD ($E0DF),A</td>
</tr>
<tr>
<td class="asm-label">ProcessOperationBlock_Loop</td>
<td class="address-2"><span id="e070"></span>E070</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Stash the repeat count on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e071"></span>E071</td>
<td class="instruction">LD A,($E0DF)</td>
<td class="comment-1" rowspan="1">Load the operation code into <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e074"></span>E074</td>
<td class="instruction">CP $C9</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e080">ProcessCompressedImageData_Next</a> if the operation code is C9.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e076"></span>E076</td>
<td class="instruction">JR Z,<a href="E004.html#e080">ProcessCompressedImageData_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e078"></span>E078</td>
<td class="instruction">CP $CA</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e080">ProcessCompressedImageData_Next</a> if the operation code is CA.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e07a"></span>E07A</td>
<td class="instruction">JR Z,<a href="E004.html#e080">ProcessCompressedImageData_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e07c"></span>E07C</td>
<td class="instruction">CP $CB</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e083">ProcessBitOperation</a> if the operation code is not CB.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e07e"></span>E07E</td>
<td class="instruction">JR NZ,<a href="E004.html#e083">ProcessBitOperation</a></td>
</tr>
<tr>
<td class="asm-label">ProcessCompressedImageData_Next</td>
<td class="address-2"><span id="e080"></span>E080</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the repeat count from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e081"></span>E081</td>
<td class="instruction">JR <a href="E004.html#e0b0">GeneratePicture_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e0b0">GeneratePicture_Next</a>.</td>
</tr>
<tr>
<td class="asm-label">ProcessBitOperation</td>
<td class="address-2"><span id="e083"></span>E083</td>
<td class="instruction">AND %11111000</td>
<td class="comment-1" rowspan="2">Mask to get the byte offset within the current line, store this in <span class="register">D</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e085"></span>E085</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e086"></span>E086</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="4">Divide the byte offset by 08 to get the pixel offset, store this in <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e087"></span>E087</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e088"></span>E088</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e089"></span>E089</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e08a"></span>E08A</td>
<td class="instruction">LD A,($E0DF)</td>
<td class="comment-1" rowspan="1">Reload the operation code into <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e08d"></span>E08D</td>
<td class="instruction">SUB D</td>
<td class="comment-1" rowspan="1">Subtract to calculate the number of bits to modify.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e08e"></span>E08E</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=00.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e090"></span>E090</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>+=<span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e091"></span>E091</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Set the bit count in <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e092"></span>E092</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Adjust <span class="register">B</span> for the loop.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e093"></span>E093</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e094"></span>E094</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e095"></span>E095</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Stash the bit count on the stack.</td>
</tr>
<tr>
<td class="asm-label">RotateBitsLeft_Loop</td>
<td class="address-2"><span id="e096"></span>E096</td>
<td class="instruction">RLA</td>
<td class="comment-1" rowspan="1">Rotate left, moving bits one position to the left.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e097"></span>E097</td>
<td class="instruction">DJNZ <a href="E004.html#e096">RotateBitsLeft_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease counter by one and loop back to <a href="E004.html#e096">RotateBitsLeft_Loop</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e099"></span>E099</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set the carry flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e09a"></span>E09A</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the bit count from the stack.</td>
</tr>
<tr>
<td class="asm-label">RotateBitsRight_Loop</td>
<td class="address-2"><span id="e09b"></span>E09B</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Rotate right, moving bits back and inserting 01.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e09c"></span>E09C</td>
<td class="instruction">DJNZ <a href="E004.html#e09b">RotateBitsRight_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the bit count by one and loop back to <a href="E004.html#e09b">RotateBitsRight_Loop</a> until all bits have been processed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e09e"></span>E09E</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e09f"></span>E09F</td>
<td class="instruction">LD HL,$E0DF</td>
<td class="comment-1" rowspan="2">Increment *<a href="E004.html#e0df">Operation_Code</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0a2"></span>E0A2</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0a3"></span>E0A3</td>
<td class="instruction">LD HL,($E0E0)</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=*<a href="E004.html#e0e0">Buffer_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0a6"></span>E0A6</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the repeat count from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0a7"></span>E0A7</td>
<td class="instruction">DJNZ <a href="E004.html#e070">ProcessOperationBlock_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the repeat count by one and loop back to <a href="E004.html#e070">ProcessOperationBlock_Loop</a> until all operations are done.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0a9"></span>E0A9</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="2">Increment <span class="register">IX</span> by two.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0ab"></span>E0AB</td>
<td class="instruction">INC IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0ad"></span>E0AD</td>
<td class="instruction">JP <a href="E004.html#e067">ProcessCompressedImageData</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e067">ProcessCompressedImageData</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e0b0"></span>
<div class="comments">
<div class="paragraph">
Has all the image been decompressed now? If not, loop back again.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Next</td>
<td class="address-2"><span id="e0b0"></span>E0B0</td>
<td class="instruction">LD HL,$E0DE</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="E004.html#e0de">Line_Counter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0b3"></span>E0B3</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrease *<span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0b4"></span>E0B4</td>
<td class="instruction">JP NZ,<a href="E004.html#e016">GeneratePicture_Loop</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="E004.html#e016">GeneratePicture_Loop</a> until *<span class="register">HL</span> is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0b7"></span>E0B7</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Move <span class="register">IX</span> to the start of the attribute data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0b9"></span>E0B9</td>
<td class="instruction">LD B,$10</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">B</span> to process 10 rows of attribute data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0bb"></span>E0BB</td>
<td class="instruction">LD HL,$AAE3</td>
<td class="comment-1" rowspan="1">Store the start of <a href="A0E3.html#aae3">Buffer_Image_Attributes</a> in <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Attributes_Loop</td>
<td class="address-2"><span id="e0be"></span>E0BE</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="2">Stash the attribute row counter and the image attributes buffer pointer on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0bf"></span>E0BF</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0c0"></span>E0C0</td>
<td class="instruction">LD A,$00</td>
<td class="comment-1" rowspan="1">Initialise the column counter in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Attribute_Row</td>
<td class="address-2"><span id="e0c2"></span>E0C2</td>
<td class="instruction">LD C,(IX+$00)</td>
<td class="comment-1" rowspan="1">Load the attribute value into <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0c5"></span>E0C5</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="2">Load the repeat length into <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0c7"></span>E0C7</td>
<td class="instruction">LD B,(IX+$00)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0ca"></span>E0CA</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Move <span class="register">IX</span> to the next attribute/ repeat length pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0cc"></span>E0CC</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">Add the repeat length to the column counter.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Attribute_Run</td>
<td class="address-2"><span id="e0cd"></span>E0CD</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Write the attribute to the image attributes buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0ce"></span>E0CE</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the image attributes buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0cf"></span>E0CF</td>
<td class="instruction">DJNZ <a href="E004.html#e0cd">GeneratePicture_Attribute_Run</a></td>
<td class="comment-1" rowspan="1">Decrease the repeat counter by one and loop back to <a href="E004.html#e0cd">GeneratePicture_Attribute_Run</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0d1"></span>E0D1</td>
<td class="instruction">CP $14</td>
<td class="comment-1" rowspan="2">Jump to <a href="E004.html#e0c2">GeneratePicture_Attribute_Row</a> if 14 columns have been processed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0d3"></span>E0D3</td>
<td class="instruction">JR NZ,<a href="E004.html#e0c2">GeneratePicture_Attribute_Row</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0d5"></span>E0D5</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the start of the current attribute row from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0d6"></span>E0D6</td>
<td class="instruction">LD BC,$0014</td>
<td class="comment-1" rowspan="2">Move <span class="register">HL</span> to the next row in the attribute buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0d9"></span>E0D9</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0da"></span>E0DA</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the attribute row counter from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0db"></span>E0DB</td>
<td class="instruction">DJNZ <a href="E004.html#e0be">GeneratePicture_Attributes_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the attribute row counter by one and loop back to <a href="E004.html#e0be">GeneratePicture_Attributes_Loop</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="e0dd"></span>E0DD</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="e0de"></span>
<div class="comments">
<div class="paragraph">
Variables specifically for this routine.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">Line_Counter</td>
<td class="address-1"><span id="e0de"></span>E0DE</td>
<td class="instruction">DEFB $00</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label">Operation_Code</td>
<td class="address-1"><span id="e0df"></span>E0DF</td>
<td class="instruction">DEFB $00</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label">Buffer_Position</td>
<td class="address-1"><span id="e0e0"></span>E0E0</td>
<td class="instruction">DEFW $0000</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="DFB2.html">DFB2</a>
</td>
<td class="up">Up: <a href="../maps/all.html#e004">Map</a></td>
<td class="next">
Next: <a href="E0E2.html">E0E2</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1986 Domark Ltd &copy; 2024 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.4.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/splittingimages/">Source code</a>.</div>
<div><a href="../dec/asm/57348.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>