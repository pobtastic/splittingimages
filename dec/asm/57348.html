<!DOCTYPE html>
<html>
<head>
<title>Splitting Images: Routine at 57348</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="57266.html">57266</a>
</td>
<td class="up">Up: <a href="../maps/all.html#57348">Map</a></td>
<td class="next">
Next: <a href="57570.html">57570</a>
</td>
</tr>
</table>
<div class="description">57348: Generate Picture</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="53921.html">Game_Initialisation</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Pointer to level graphics data</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="57348"></span>
<div class="comments">
<div class="paragraph">
<span class="register">IX</span> will point to one of: <table class="default">
<tr>
<th colspan="1" rowspan="1">Address</th>
<th colspan="1" rowspan="1">Level</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="23296.html">GraphicsData_Level_01</a></td>
<td class="centre" colspan="1" rowspan="1">Level 01</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="24962.html">GraphicsData_Level_02</a></td>
<td class="centre" colspan="1" rowspan="1">Level 02</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="27391.html">GraphicsData_Level_03</a></td>
<td class="centre" colspan="1" rowspan="1">Level 03</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="29450.html">GraphicsData_Level_04</a></td>
<td class="centre" colspan="1" rowspan="1">Level 04</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="30780.html">GraphicsData_Level_05</a></td>
<td class="centre" colspan="1" rowspan="1">Level 05</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="31997.html">GraphicsData_Level_06</a></td>
<td class="centre" colspan="1" rowspan="1">Level 06</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="33030.html">GraphicsData_Level_07</a></td>
<td class="centre" colspan="1" rowspan="1">Level 07</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="35282.html">GraphicsData_Level_08</a></td>
<td class="centre" colspan="1" rowspan="1">Level 08</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="37136.html">GraphicsData_Level_09</a></td>
<td class="centre" colspan="1" rowspan="1">Level 09</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a href="38770.html">GraphicsData_Level_10</a></td>
<td class="centre" colspan="1" rowspan="1">Level 10</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture</td>
<td class="address-2"><span id="57348"></span>57348</td>
<td class="instruction">LD HL,41187</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="41187.html">Buffer_Image</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="57351"></span>
<div class="comments">
<div class="paragraph">
Clear down the buffer ready for the new image to be generated.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57351"></span>57351</td>
<td class="instruction">LD BC,2880</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=2880.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57354"></span>57354</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Write 0 to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57356"></span>57356</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="3"><span class="register">DE</span>=<a href="41187.html">Buffer_Image</a>+1 (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57357"></span>57357</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57358"></span>57358</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57359"></span>57359</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">Clear 2880 bytes of data in <a href="41187.html">Buffer_Image</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57361"></span>57361</td>
<td class="instruction">LD A,128</td>
<td class="comment-1" rowspan="2">Write 128 to *<a href="57348.html#57566">Line_Counter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57363"></span>57363</td>
<td class="instruction">LD (57566),A</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Loop</td>
<td class="address-2"><span id="57366"></span>57366</td>
<td class="instruction">LD A,128</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=128-*<a href="57348.html#57566">Line_Counter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57368"></span>57368</td>
<td class="instruction">LD HL,57566</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57371"></span>57371</td>
<td class="instruction">SUB (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57372"></span>57372</td>
<td class="instruction">LD B,20</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=20.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57374"></span>57374</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="2">Load <span class="register">A</span> into <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57376"></span>57376</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57377"></span>57377</td>
<td class="instruction">LD HL,41187</td>
<td class="comment-1" rowspan="1">Starting from the first address at <a href="41187.html">Buffer_Image</a>, stored in <span class="register">HL</span>...</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_CurrentLine_Loop</td>
<td class="address-2"><span id="57380"></span>57380</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">Keep adding <span class="register">DE</span> to <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57381"></span>57381</td>
<td class="instruction">DJNZ <a href="57348.html#57380">GeneratePicture_CurrentLine_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease counter by one and loop back to <a href="57348.html#57380">GeneratePicture_CurrentLine_Loop</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57383"></span>57383</td>
<td class="instruction">LD (57568),HL</td>
<td class="comment-1" rowspan="1">Write <span class="register">HL</span> to *<a href="57348.html#57568">Buffer_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57386"></span>57386</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the level graphics data pointer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57389"></span>57389</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57391"></span>57391</td>
<td class="instruction">CP 201</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57447">ProcessCompressedImageData</a> if <span class="register">A</span> is equal to 201.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57393"></span>57393</td>
<td class="instruction">JR Z,<a href="57348.html#57447">ProcessCompressedImageData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57395"></span>57395</td>
<td class="instruction">CP 202</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57413">GeneratePicture_RLE_Decoding</a> if <span class="register">A</span> is equal to 202.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57397"></span>57397</td>
<td class="instruction">JR Z,<a href="57348.html#57413">GeneratePicture_RLE_Decoding</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57399"></span>57399</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Copy the level graphics data pointer into <span class="register">DE</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57401"></span>57401</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57402"></span>57402</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Exchange the <span class="register">DE</span> and <span class="register">HL</span> registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57403"></span>57403</td>
<td class="instruction">LD BC,20</td>
<td class="comment-1" rowspan="2">Copy 0020 bytes of data from <span class="register">HL</span> to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57406"></span>57406</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57408"></span>57408</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Update the level graphics data pointer in <span class="register">IX</span> with the progress made from <span class="register">HL</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57409"></span>57409</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57411"></span>57411</td>
<td class="instruction">JR <a href="57348.html#57520">GeneratePicture_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57520">GeneratePicture_Next</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="57413"></span>
<div class="comments">
<div class="paragraph">
Run-length decoding.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_Decoding</td>
<td class="address-2"><span id="57413"></span>57413</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="2">Copy the level graphics data pointer into <span class="register">DE</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57415"></span>57415</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_NormalData</td>
<td class="address-2"><span id="57416"></span>57416</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the level graphics data pointer in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57417"></span>57417</td>
<td class="instruction">CP 0</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57426">GeneratePicture_RLE_RepeatZero</a> if the byte is 0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57419"></span>57419</td>
<td class="instruction">JR Z,<a href="57348.html#57426">GeneratePicture_RLE_RepeatZero</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57421"></span>57421</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Else, write the byte to the image buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57422"></span>57422</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the image buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57423"></span>57423</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57424"></span>57424</td>
<td class="instruction">JR <a href="57348.html#57416">GeneratePicture_RLE_NormalData</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57416">GeneratePicture_RLE_NormalData</a>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_RepeatZero</td>
<td class="address-2"><span id="57426"></span>57426</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57427"></span>57427</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the level graphics data pointer in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57428"></span>57428</td>
<td class="instruction">CP 0</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57441">GeneratePicture_RLE_Next</a> if the byte is 0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57430"></span>57430</td>
<td class="instruction">JR Z,<a href="57348.html#57441">GeneratePicture_RLE_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57432"></span>57432</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy the fetched byte into <span class="register">B</span> as a repeat counter</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57433"></span>57433</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Write 0 to the image buffer.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_RepeatZero_Loop</td>
<td class="address-2"><span id="57434"></span>57434</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57435"></span>57435</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the image buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57436"></span>57436</td>
<td class="instruction">DJNZ <a href="57348.html#57434">GeneratePicture_RLE_RepeatZero_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the byte repeat counter by one and loop back to <a href="57348.html#57434">GeneratePicture_RLE_RepeatZero_Loop</a> until the counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57438"></span>57438</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57439"></span>57439</td>
<td class="instruction">JR <a href="57348.html#57416">GeneratePicture_RLE_NormalData</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57416">GeneratePicture_RLE_NormalData</a>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_RLE_Next</td>
<td class="address-2"><span id="57441"></span>57441</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Increment the level graphics data pointer (in <span class="register">DE</span>) by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57442"></span>57442</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="2">Update the level graphics data pointer in <span class="register">IX</span> with the progress made from <span class="register">DE</span> (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57443"></span>57443</td>
<td class="instruction">POP IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57445"></span>57445</td>
<td class="instruction">JR <a href="57348.html#57520">GeneratePicture_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57520">GeneratePicture_Next</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="57447"></span>
<div class="comments">
<div class="paragraph">
Second
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ProcessCompressedImageData</td>
<td class="address-2"><span id="57447"></span>57447</td>
<td class="instruction">LD B,(IX+1)</td>
<td class="comment-1" rowspan="1">Load the repeat count into <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57450"></span>57450</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="2">Write the operation code to *<a href="57348.html#57567">Operation_Code</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57453"></span>57453</td>
<td class="instruction">LD (57567),A</td>
</tr>
<tr>
<td class="asm-label">ProcessOperationBlock_Loop</td>
<td class="address-2"><span id="57456"></span>57456</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Stash the repeat count on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57457"></span>57457</td>
<td class="instruction">LD A,(57567)</td>
<td class="comment-1" rowspan="1">Load the operation code into <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57460"></span>57460</td>
<td class="instruction">CP 201</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57472">ProcessCompressedImageData_Next</a> if the operation code is 201.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57462"></span>57462</td>
<td class="instruction">JR Z,<a href="57348.html#57472">ProcessCompressedImageData_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57464"></span>57464</td>
<td class="instruction">CP 202</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57472">ProcessCompressedImageData_Next</a> if the operation code is 202.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57466"></span>57466</td>
<td class="instruction">JR Z,<a href="57348.html#57472">ProcessCompressedImageData_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57468"></span>57468</td>
<td class="instruction">CP 203</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57475">ProcessBitOperation</a> if the operation code is not 203.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57470"></span>57470</td>
<td class="instruction">JR NZ,<a href="57348.html#57475">ProcessBitOperation</a></td>
</tr>
<tr>
<td class="asm-label">ProcessCompressedImageData_Next</td>
<td class="address-2"><span id="57472"></span>57472</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the repeat count from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57473"></span>57473</td>
<td class="instruction">JR <a href="57348.html#57520">GeneratePicture_Next</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57520">GeneratePicture_Next</a>.</td>
</tr>
<tr>
<td class="asm-label">ProcessBitOperation</td>
<td class="address-2"><span id="57475"></span>57475</td>
<td class="instruction">AND %11111000</td>
<td class="comment-1" rowspan="2">Mask to get the byte offset within the current line, store this in <span class="register">D</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57477"></span>57477</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57478"></span>57478</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="4">Divide the byte offset by 8 to get the pixel offset, store this in <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57479"></span>57479</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57480"></span>57480</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57481"></span>57481</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57482"></span>57482</td>
<td class="instruction">LD A,(57567)</td>
<td class="comment-1" rowspan="1">Reload the operation code into <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57485"></span>57485</td>
<td class="instruction">SUB D</td>
<td class="comment-1" rowspan="1">Subtract to calculate the number of bits to modify.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57486"></span>57486</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="1"><span class="register">D</span>=0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57488"></span>57488</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>+=<span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57489"></span>57489</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Set the bit count in <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57490"></span>57490</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Adjust <span class="register">B</span> for the loop.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57491"></span>57491</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57492"></span>57492</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Clear the carry flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57493"></span>57493</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Stash the bit count on the stack.</td>
</tr>
<tr>
<td class="asm-label">RotateBitsLeft_Loop</td>
<td class="address-2"><span id="57494"></span>57494</td>
<td class="instruction">RLA</td>
<td class="comment-1" rowspan="1">Rotate left, moving bits one position to the left.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57495"></span>57495</td>
<td class="instruction">DJNZ <a href="57348.html#57494">RotateBitsLeft_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease counter by one and loop back to <a href="57348.html#57494">RotateBitsLeft_Loop</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57497"></span>57497</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set the carry flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57498"></span>57498</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the bit count from the stack.</td>
</tr>
<tr>
<td class="asm-label">RotateBitsRight_Loop</td>
<td class="address-2"><span id="57499"></span>57499</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Rotate right, moving bits back and inserting 1.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57500"></span>57500</td>
<td class="instruction">DJNZ <a href="57348.html#57499">RotateBitsRight_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the bit count by one and loop back to <a href="57348.html#57499">RotateBitsRight_Loop</a> until all bits have been processed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57502"></span>57502</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57503"></span>57503</td>
<td class="instruction">LD HL,57567</td>
<td class="comment-1" rowspan="2">Increment *<a href="57348.html#57567">Operation_Code</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57506"></span>57506</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57507"></span>57507</td>
<td class="instruction">LD HL,(57568)</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=*<a href="57348.html#57568">Buffer_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57510"></span>57510</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the repeat count from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57511"></span>57511</td>
<td class="instruction">DJNZ <a href="57348.html#57456">ProcessOperationBlock_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the repeat count by one and loop back to <a href="57348.html#57456">ProcessOperationBlock_Loop</a> until all operations are done.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57513"></span>57513</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="2">Increment <span class="register">IX</span> by two.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57515"></span>57515</td>
<td class="instruction">INC IX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57517"></span>57517</td>
<td class="instruction">JP <a href="57348.html#57447">ProcessCompressedImageData</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57447">ProcessCompressedImageData</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="57520"></span>
<div class="comments">
<div class="paragraph">
Has all the image been decompressed now? If not, loop back again.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Next</td>
<td class="address-2"><span id="57520"></span>57520</td>
<td class="instruction">LD HL,57566</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="57348.html#57566">Line_Counter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57523"></span>57523</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrease *<span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57524"></span>57524</td>
<td class="instruction">JP NZ,<a href="57348.html#57366">GeneratePicture_Loop</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="57348.html#57366">GeneratePicture_Loop</a> until *<span class="register">HL</span> is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57527"></span>57527</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Move <span class="register">IX</span> to the start of the attribute data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57529"></span>57529</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">B</span> to process 16 rows of attribute data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57531"></span>57531</td>
<td class="instruction">LD HL,43747</td>
<td class="comment-1" rowspan="1">Store the start of <a href="41187.html#43747">Buffer_Image_Attributes</a> in <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Attributes_Loop</td>
<td class="address-2"><span id="57534"></span>57534</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="2">Stash the attribute row counter and the image attributes buffer pointer on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57535"></span>57535</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57536"></span>57536</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Initialise the column counter in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Attribute_Row</td>
<td class="address-2"><span id="57538"></span>57538</td>
<td class="instruction">LD C,(IX+0)</td>
<td class="comment-1" rowspan="1">Load the attribute value into <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57541"></span>57541</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="2">Load the repeat length into <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57543"></span>57543</td>
<td class="instruction">LD B,(IX+0)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57546"></span>57546</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Move <span class="register">IX</span> to the next attribute/ repeat length pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57548"></span>57548</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">Add the repeat length to the column counter.</td>
</tr>
<tr>
<td class="asm-label">GeneratePicture_Attribute_Run</td>
<td class="address-2"><span id="57549"></span>57549</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Write the attribute to the image attributes buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57550"></span>57550</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the image attributes buffer pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57551"></span>57551</td>
<td class="instruction">DJNZ <a href="57348.html#57549">GeneratePicture_Attribute_Run</a></td>
<td class="comment-1" rowspan="1">Decrease the repeat counter by one and loop back to <a href="57348.html#57549">GeneratePicture_Attribute_Run</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57553"></span>57553</td>
<td class="instruction">CP 20</td>
<td class="comment-1" rowspan="2">Jump to <a href="57348.html#57538">GeneratePicture_Attribute_Row</a> if 20 columns have been processed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57555"></span>57555</td>
<td class="instruction">JR NZ,<a href="57348.html#57538">GeneratePicture_Attribute_Row</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57557"></span>57557</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the start of the current attribute row from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57558"></span>57558</td>
<td class="instruction">LD BC,20</td>
<td class="comment-1" rowspan="2">Move <span class="register">HL</span> to the next row in the attribute buffer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57561"></span>57561</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57562"></span>57562</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the attribute row counter from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57563"></span>57563</td>
<td class="instruction">DJNZ <a href="57348.html#57534">GeneratePicture_Attributes_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the attribute row counter by one and loop back to <a href="57348.html#57534">GeneratePicture_Attributes_Loop</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="57565"></span>57565</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="57566"></span>
<div class="comments">
<div class="paragraph">
Variables specifically for this routine.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">Line_Counter</td>
<td class="address-1"><span id="57566"></span>57566</td>
<td class="instruction">DEFB 0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label">Operation_Code</td>
<td class="address-1"><span id="57567"></span>57567</td>
<td class="instruction">DEFB 0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label">Buffer_Position</td>
<td class="address-1"><span id="57568"></span>57568</td>
<td class="instruction">DEFW 0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="57266.html">57266</a>
</td>
<td class="up">Up: <a href="../maps/all.html#57348">Map</a></td>
<td class="next">
Next: <a href="57570.html">57570</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1986 Domark Ltd &copy; 2024 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.4.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/splittingimages/">Source code</a>.</div>
<div><a href="../../asm/E004.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>