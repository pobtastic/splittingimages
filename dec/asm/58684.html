<!DOCTYPE html>
<html>
<head>
<title>Splitting Images: Routine at 58684</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="58642.html">58642</a>
</td>
<td class="up">Up: <a href="../maps/all.html#58684">Map</a></td>
<td class="next">
Next: <a href="58800.html">58800</a>
</td>
</tr>
</table>
<div class="description">58684: Handler: Cursor Movement</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="58268.html">Controls_CheckRight</a>, <a href="58361.html">Controls_CheckLeft</a>, <a href="58452.html">Controls_CheckDown</a>, <a href="58491.html">Controls_CheckUp</a> and <a href="58642.html">Controls_CheckLeftUp</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">Handler_CursorMovement</td>
<td class="address-2"><span id="58684"></span>58684</td>
<td class="instruction">CALL <a href="58058.html">FetchTileObject</a></td>
<td class="comment-1" rowspan="1">Call <a href="58058.html">FetchTileObject</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58687"></span>58687</td>
<td class="instruction">LD A,(55340)</td>
<td class="comment-1" rowspan="2">Write *<a href="55340.html">DestinationCursor_Y_Position</a> to *<a href="55344.html">StorageCursor_Y_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58690"></span>58690</td>
<td class="instruction">LD (55344),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58693"></span>58693</td>
<td class="instruction">LD A,(55341)</td>
<td class="comment-1" rowspan="2">Write *<a href="55340.html#55341">DestinationCursor_X_Position</a> to *<a href="55344.html#55345">StorageCursor_X_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58696"></span>58696</td>
<td class="instruction">LD (55345),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58699"></span>58699</td>
<td class="instruction">LD A,R</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=the contents of the Memory Refresh Register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58701"></span>58701</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="2">Multiply <span class="register">A</span> by 2 and store the result in <span class="register">L</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58702"></span>58702</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58703"></span>58703</td>
<td class="instruction">LD H,0</td>
<td class="comment-1" rowspan="1"><span class="register">H</span>=0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58705"></span>58705</td>
<td class="instruction">LD B,70</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">B</span> for the first outer loop.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58707"></span>58707</td>
<td class="instruction">LD D,5</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">D</span> for the first inner loop.</td>
</tr>
<tr>
<td class="asm-label">CursorMovement_SoundLoop_01</td>
<td class="address-2"><span id="58709"></span>58709</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the ZX Spectrum ROM and store it in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58710"></span>58710</td>
<td class="instruction">AND %00011000</td>
<td class="comment-1" rowspan="1">Keep only bits 3-4.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58712"></span>58712</td>
<td class="instruction">OR %00000101</td>
<td class="comment-1" rowspan="1">Set bits 0, 2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58714"></span>58714</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-1" rowspan="1">Send to the speaker.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58716"></span>58716</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the ROM pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58717"></span>58717</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Stash the outer loop counter on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58718"></span>58718</td>
<td class="instruction">LD B,D</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to the inner loop counter held by <span class="register">D</span>.</td>
</tr>
<tr>
<td class="asm-label">CursorMovement_DelayLoop_01</td>
<td class="address-2"><span id="58719"></span>58719</td>
<td class="instruction">DJNZ <a href="58684.html#58719">CursorMovement_DelayLoop_01</a></td>
<td class="comment-1" rowspan="1">Decrease the inner loop counter by one and loop back to <a href="58684.html#58719">CursorMovement_DelayLoop_01</a> until the counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58721"></span>58721</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the outer loop counter from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58722"></span>58722</td>
<td class="instruction">DJNZ <a href="58684.html#58709">CursorMovement_SoundLoop_01</a></td>
<td class="comment-1" rowspan="1">Decrease the outer loop counter by one and loop back to <a href="58684.html#58709">CursorMovement_SoundLoop_01</a> until the counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58724"></span>58724</td>
<td class="instruction">HALT</td>
<td class="comment-1" rowspan="1">Halt operation (suspend CPU until the next interrupt).</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="58725"></span>
<div class="comments">
<div class="paragraph">
Update the cursor position.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58725"></span>58725</td>
<td class="instruction">LD A,(55340)</td>
<td class="comment-1" rowspan="4">Jump to <a href="58684.html#58741">Handler_CursorMovement_1</a> if *<a href="55340.html">DestinationCursor_Y_Position</a> is equal to *<a href="55342.html">CurrentCursor_Y_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58728"></span>58728</td>
<td class="instruction">LD HL,55342</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58731"></span>58731</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58732"></span>58732</td>
<td class="instruction">JR Z,<a href="58684.html#58741">Handler_CursorMovement_1</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58734"></span>58734</td>
<td class="instruction">JP P,<a href="58684.html#58740">Handler_CursorMovement_0</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="58684.html#58740">Handler_CursorMovement_0</a> if *<a href="55340.html">DestinationCursor_Y_Position</a> is greater than or equal to *<a href="55342.html">CurrentCursor_Y_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58737"></span>58737</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrease *<a href="55342.html">CurrentCursor_Y_Position</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58738"></span>58738</td>
<td class="instruction">JR <a href="58684.html#58741">Handler_CursorMovement_1</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="58684.html#58741">Handler_CursorMovement_1</a>.</td>
</tr>
<tr>
<td class="asm-label">Handler_CursorMovement_0</td>
<td class="address-2"><span id="58740"></span>58740</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Increment *<span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label">Handler_CursorMovement_1</td>
<td class="address-2"><span id="58741"></span>58741</td>
<td class="instruction">LD A,(55341)</td>
<td class="comment-1" rowspan="4">Jump to <a href="58684.html#58757">Handler_CursorMovement_3</a> if *<a href="55340.html#55341">DestinationCursor_X_Position</a> is equal to *<a href="55342.html#55343">CurrentCursor_X_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58744"></span>58744</td>
<td class="instruction">LD HL,55343</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58747"></span>58747</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58748"></span>58748</td>
<td class="instruction">JR Z,<a href="58684.html#58757">Handler_CursorMovement_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58750"></span>58750</td>
<td class="instruction">JP P,<a href="58684.html#58756">Handler_CursorMovement_2</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="58684.html#58756">Handler_CursorMovement_2</a> if *<a href="55340.html#55341">DestinationCursor_X_Position</a> is greater than or equal to *<a href="55342.html#55343">CurrentCursor_X_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58753"></span>58753</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrease *<a href="55342.html#55343">CurrentCursor_X_Position</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58754"></span>58754</td>
<td class="instruction">JR <a href="58684.html#58757">Handler_CursorMovement_3</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="58684.html#58757">Handler_CursorMovement_3</a>.</td>
</tr>
<tr>
<td class="asm-label">Handler_CursorMovement_2</td>
<td class="address-2"><span id="58756"></span>58756</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Increment *<span class="register">HL</span> by one.</td>
</tr>
<tr>
<td class="asm-label">Handler_CursorMovement_3</td>
<td class="address-2"><span id="58757"></span>58757</td>
<td class="instruction">LD A,(55342)</td>
<td class="comment-1" rowspan="4">Jump to <a href="58684.html">Handler_CursorMovement</a> if *<a href="55342.html">CurrentCursor_Y_Position</a> is not equal to *<a href="55340.html">DestinationCursor_Y_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58760"></span>58760</td>
<td class="instruction">LD HL,55340</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58763"></span>58763</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58764"></span>58764</td>
<td class="instruction">JR NZ,<a href="58684.html#58684">Handler_CursorMovement</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58766"></span>58766</td>
<td class="instruction">LD A,(55343)</td>
<td class="comment-1" rowspan="4">Jump to <a href="58684.html">Handler_CursorMovement</a> if *<a href="55342.html#55343">CurrentCursor_X_Position</a> is not equal to *<a href="55340.html#55341">DestinationCursor_X_Position</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58769"></span>58769</td>
<td class="instruction">LD HL,55341</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58772"></span>58772</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58773"></span>58773</td>
<td class="instruction">JR NZ,<a href="58684.html#58684">Handler_CursorMovement</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="58775"></span>
<div class="comments">
<div class="paragraph">
The final sound effect when the cursor reaches its destination.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58775"></span>58775</td>
<td class="instruction">LD A,R</td>
<td class="comment-1" rowspan="2">Set the lower byte in <span class="register">L</span>, which for randomness is the contents of the Memory Refresh Register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58777"></span>58777</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58778"></span>58778</td>
<td class="instruction">LD H,10</td>
<td class="comment-1" rowspan="1">Set the upper byte of the sound data address (0A00-0AFF).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58780"></span>58780</td>
<td class="instruction">LD B,35</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">B</span> for the second outer loop.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58782"></span>58782</td>
<td class="instruction">LD C,100</td>
<td class="comment-1" rowspan="1">Set a counter in <span class="register">C</span> for the second inner loop.</td>
</tr>
<tr>
<td class="asm-label">CursorMovement_SoundLoop_02</td>
<td class="address-2"><span id="58784"></span>58784</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch a byte from the ZX Spectrum ROM and store it in <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58785"></span>58785</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the ROM pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58786"></span>58786</td>
<td class="instruction">AND %00011000</td>
<td class="comment-1" rowspan="1">Keep only bits 3-4.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58788"></span>58788</td>
<td class="instruction">OR %00000101</td>
<td class="comment-1" rowspan="1">Set bits 0, 2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58790"></span>58790</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-1" rowspan="1">Send to the speaker.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58792"></span>58792</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Stash the outer loop counter on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58793"></span>58793</td>
<td class="instruction">LD B,C</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to the inner loop counter held by <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label">CursorMovement_DelayLoop_02</td>
<td class="address-2"><span id="58794"></span>58794</td>
<td class="instruction">DJNZ <a href="58684.html#58794">CursorMovement_DelayLoop_02</a></td>
<td class="comment-1" rowspan="1">Decrease the inner loop counter by one and loop back to <a href="58684.html#58794">CursorMovement_DelayLoop_02</a> until counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58796"></span>58796</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the outer loop counter from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58797"></span>58797</td>
<td class="instruction">DJNZ <a href="58684.html#58784">CursorMovement_SoundLoop_02</a></td>
<td class="comment-1" rowspan="1">Decrease the outer loop counter by one and loop back to <a href="58684.html#58784">CursorMovement_SoundLoop_02</a> until the counter is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="58799"></span>58799</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="58642.html">58642</a>
</td>
<td class="up">Up: <a href="../maps/all.html#58684">Map</a></td>
<td class="next">
Next: <a href="58800.html">58800</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1986 Domark Ltd &copy; 2024 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.4.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/splittingimages/">Source code</a>.</div>
<div><a href="../../asm/E53C.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>